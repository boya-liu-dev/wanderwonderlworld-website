import{P as lt,_ as dt,Q as f,R as ct,S as D,T as rt,U as ut,V as vt,c as y,o as h,a,b as U,F as H,t as S,d as I,W as u,X as v,r as pt,Y as R,Z as B,$ as mt,a0 as ft,a1 as j,a2 as yt,a3 as ht,a4 as gt,a5 as _t,a6 as bt}from"./index-C1DAlrm4.js";let b=null;function C(p,d){return d.split(".").reduce((c,o)=>c&&o in c?c[o]:void 0,p)}function V(p,d,c){const o=String(d).split(".").filter(Boolean);let i=p;for(let s=0;s<o.length-1;s++){const m=o[s];(!i[m]||typeof i[m]!="object")&&(i[m]={}),i=i[m]}i[o[o.length-1]]=c}function wt(p,d){var c;if(d&&String(d).toLowerCase().startsWith("price-")){const o=((c=d.split("-")[1])==null?void 0:c.toUpperCase())||"AED",i=Number(p);return Number.isFinite(i)?`${o} ${i.toFixed(0)}`:String(p)}return String(p)}function kt(p){const d=String(p??"").replace(/,/g,"").match(/-?\d+(\.\d+)?/);return d?Number(d[0]):NaN}async function At(){if(b)return b;try{b=await lt()}catch{b={}}return b}function J(){b=null}async function W(p=document){const d=await At(),c=o=>Array.from(p.querySelectorAll(o));c("[data-c]").forEach(o=>{const i=o.dataset.c==="@id"?o.id:o.dataset.c,s=C(d,i);s!=null&&(o.textContent=String(s))}),c("[data-c-html]").forEach(o=>{const i=o.dataset.cHtml==="@id"?o.id:o.dataset.cHtml,s=C(d,i);s!=null&&(o.innerHTML=String(s))}),c("[data-c-src]").forEach(o=>{const i=o.dataset.cSrc==="@id"?o.id:o.dataset.cSrc,s=C(d,i);s&&(o.tagName==="A"?o.setAttribute("href",s):o.setAttribute("src",s))}),c("[data-c-num]").forEach(o=>{const i=o.dataset.cNum==="@id"?o.id:o.dataset.cNum,s=C(d,i);if(s!=null){const m=o.dataset.format||"";o.textContent=wt(s,m)}})}function P(p=document){const d={},c=o=>Array.from(p.querySelectorAll(o));return c("[data-c]").forEach(o=>{const i=o.dataset.c==="@id"?o.id:o.dataset.c;if(!i)return;const s=(o.textContent||"").trim();s!==""&&V(d,i,s)}),c("[data-c-html]").forEach(o=>{const i=o.dataset.cHtml==="@id"?o.id:o.dataset.cHtml;if(!i)return;const s=(o.innerHTML||"").trim();s!==""&&V(d,i,s)}),c("[data-c-src]").forEach(o=>{const i=o.dataset.cSrc==="@id"?o.id:o.dataset.cSrc;if(!i)return;const s=o.tagName==="A",m=o.getAttribute(s?"href":"src");m&&V(d,i,m)}),c("[data-c-num]").forEach(o=>{const i=o.dataset.cNum==="@id"?o.id:o.dataset.cNum;if(!i)return;const s=(o.textContent||"").trim(),m=kt(s);V(d,i,Number.isFinite(m)?m:s)}),d}const Ut={class:"admin-wrap"},St={class:"admin-top"},Nt={class:"u"},Ct={key:0,class:"card login"},Vt={key:1,class:"card"},xt={class:"actions"},Lt=["disabled"],Tt=["disabled"],Dt=["disabled"],Et={key:0,class:"preview"},Yt={key:2,class:"card"},Ot={class:"img-uploader"},$t=["disabled"],Mt={key:0,class:"img-preview"},Ft=["href"],Ht=["src"],It={key:3,class:"card"},Rt={class:"news-list"},Bt={class:"c short"},jt=["onUpdate:modelValue"],Jt={class:"c short"},Wt=["onUpdate:modelValue"],Pt={class:"c grow"},Kt=["onUpdate:modelValue"],Gt={class:"c grow"},qt=["onUpdate:modelValue"],Qt={class:"c grow"},Xt=["onUpdate:modelValue"],Zt={class:"c grow"},zt=["onUpdate:modelValue"],te={class:"c mid"},ee=["onUpdate:modelValue"],ae={class:"c mid"},oe=["onUpdate:modelValue"],ne={class:"c short"},se=["onUpdate:modelValue"],ie={class:"c ops"},le=["onClick"],de=["onClick"],ce={class:"news-row add"},re={class:"c short"},ue={class:"c short"},ve={class:"c grow"},pe={class:"c grow"},me={class:"c grow"},fe={class:"c grow"},ye={class:"c mid"},he={class:"c mid"},ge={class:"c short"},K="admin_local_fallback_ok",_e="Boya",be={__name:"Admin",setup(p){const d=f(null);ct(n=>{d.value=n});const c=f(localStorage.getItem(K)==="1"),o=D(()=>!!d.value||c.value),i=D(()=>{var n;return((n=d.value)==null?void 0:n.email)||`${_e}（口令）`});f(!1),f("");async function s(){try{await ft()}catch(n){console.error(n),alert("登录失败，请重试")}}async function m(){try{await mt()}finally{localStorage.removeItem(K),c.value=!1}}const g=f(null),G=D(()=>JSON.stringify(g.value||{},null,2)),N=f(!1);function E(n,e){for(const t in e)e[t]&&typeof e[t]=="object"&&!Array.isArray(e[t])?((!n[t]||typeof n[t]!="object")&&(n[t]={}),E(n[t],e[t])):n[t]=e[t];return n}function q(){g.value=P(document),setTimeout(()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),0)}const Y=f(null),w=f(!1),x=f("");function Q(){const n=bt.getRoutes().map(t=>t.path).filter(t=>t&&t!=="/admin"&&t!=="/newsboard"&&!t.includes(":")&&!t.startsWith("/404")),e=[];return Array.from(new Set([...n,...e]))}function X(n){return new Promise(e=>{const t=Y.value,l=()=>{var F;try{const T=t.contentDocument||((F=t.contentWindow)==null?void 0:F.document),it=P(T);e(it||{})}catch(T){console.warn("scan failed for",n,T),e({})}},M=()=>{setTimeout(l,200),t.removeEventListener("load",M)};t.addEventListener("load",M),t.src=n.startsWith("http")?n:`${location.origin}${n}`})}async function Z(){if(w.value)return;w.value=!0;const n={},e=Q();for(let t=0;t<e.length;t++){x.value=`${t+1}/${e.length}：${e[t]}`;const l=await X(e[t]);E(n,l)}g.value=n,w.value=!1,x.value="",setTimeout(()=>window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}),0)}async function z(){if(g.value){N.value=!0;try{await j(g.value),J(),await W(document),alert("已保存到 Firestore（site/content）并立即生效。")}catch(n){console.error(n),alert("保存失败，请检查控制台与 Firestore 规则。")}finally{N.value=!1}}}function tt(){const n=new Blob([JSON.stringify(g.value||{},null,2)],{type:"application/json"}),e=URL.createObjectURL(n),t=document.createElement("a");t.href=e,t.download="site-content-snapshot.json",t.click(),URL.revokeObjectURL(e)}const k=f(""),_=f(null),A=f("");function et(n){var e;_.value=((e=n.target.files)==null?void 0:e[0])||null}async function at(){if(!(!k.value||!_.value))try{const n=`images/site/${Date.now()}_${_.value.name}`,e=await yt(_.value,n);A.value=e,await j({[k.value]:e}),J(),await W(document),alert(`已写入键：${k.value}`),_.value=null}catch(n){console.error(n),alert("上传或保存失败")}}const O=f([]),r=f({pin:!1,variant:"info",title:"",body:"",ctaText:"",ctaLink:"",startAt:"",endAt:"",priority:0});let L=null;rt(()=>{L=ut(n=>{const e=(n||[]).map(t=>({_id:t.id,pin:!!t.pin,variant:t.variant||"info",title:t.title||"",body:t.body||"",ctaText:t.ctaText||"",ctaLink:t.ctaLink||"",startAt:$(t.startAt),endAt:$(t.endAt),priority:Number(t.priority||0)}));O.value=e.sort((t,l)=>(l.pin?1:0)!=(t.pin?1:0)?(l.pin?1:0)-(t.pin?1:0):l.priority!==t.priority?l.priority-t.priority:(l.startAt||"").localeCompare(t.startAt||""))})}),vt(()=>{L&&L()});function $(n){const e=n!=null&&n.toDate?n.toDate():typeof n=="string"?new Date(n):n;return!(e instanceof Date)||isNaN(e.getTime())?"":e.toISOString().slice(0,10)}async function ot(){const n={...r.value};if(!n.title)return alert("请填写标题");try{await _t(n),r.value={pin:!1,variant:"info",title:"",body:"",ctaText:"",ctaLink:"",startAt:"",endAt:"",priority:0}}catch(e){console.error(e),alert("新增失败")}}async function nt(n){try{await ht(n._id,{pin:!!n.pin,variant:n.variant||"info",title:n.title||"",body:n.body||"",ctaText:n.ctaText||"",ctaLink:n.ctaLink||"",startAt:n.startAt?new Date(n.startAt):null,endAt:n.endAt?new Date(n.endAt):null,priority:Number(n.priority||0)}),alert("已保存")}catch(e){console.error(e),alert("保存失败")}}async function st(n){if(confirm("确定删除该条公告？"))try{await gt(n._id)}catch(e){console.error(e),alert("删除失败")}}return(n,e)=>(h(),y("div",Ut,[a("header",St,[e[10]||(e[10]=a("h2",null,"Admin — 站点内容管理",-1)),e[11]||(e[11]=a("div",{class:"spacer"},null,-1)),o.value?(h(),y(H,{key:0},[a("span",Nt,S(i.value),1),a("button",{class:"btn",onClick:m},"退出登录")],64)):U("",!0)]),o.value?(h(),y("section",Vt,[e[14]||(e[14]=I('<h3 data-v-5e94a80e>一键扫描页面 → 生成 / 保存内容 JSON</h3><p class="hint" data-v-5e94a80e> 支持两种扫描方式：<br data-v-5e94a80e> 1)「扫描当前页面」：采集当前路由已渲染 DOM 中带有 <code data-v-5e94a80e>data-c</code> / <code data-v-5e94a80e>data-c-html</code> / <code data-v-5e94a80e>data-c-src</code> / <code data-v-5e94a80e>data-c-num</code>（含 <code data-v-5e94a80e>@id</code>）的元素。<br data-v-5e94a80e> 2)「扫描全站」：通过隐藏 iframe 逐个加载路由并采集，自动合并成一份 JSON。 </p>',2)),a("div",xt,[a("button",{class:"btn",onClick:q},"扫描当前页面"),a("button",{class:"btn",disabled:w.value,onClick:Z},S(w.value?`扫描中 ${x.value}`:"扫描全站"),9,Lt),a("button",{class:"btn",disabled:!g.value||N.value,onClick:z},S(N.value?"保存中…":"保存到 Firestore（site/content）"),9,Tt),a("button",{class:"btn",disabled:!g.value,onClick:tt},"下载 JSON",8,Dt)]),g.value?(h(),y("pre",Et,S(G.value),1)):U("",!0),a("iframe",{ref_key:"scanFrame",ref:Y,class:"scan-frame",style:{display:"none"}},null,512)])):(h(),y("section",Ct,[e[12]||(e[12]=a("h3",null,"登录后台",-1)),a("div",{class:"actions"},[a("button",{class:"btn primary",onClick:s},"使用 Google 登录")]),e[13]||(e[13]=a("p",{class:"hint sm mt8"},"只有管理员有权限操作。",-1))])),o.value?(h(),y("section",Yt,[e[16]||(e[16]=a("h3",null,"图片上传（写入 site/content 任意键）",-1)),a("div",Ot,[u(a("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>k.value=t),class:"key",placeholder:"例如 home.hero.image 或 transfers.banner"},null,512),[[v,k.value,void 0,{trim:!0}]]),a("input",{type:"file",accept:"image/*",onChange:et},null,32),a("button",{class:"btn",disabled:!_.value,onClick:at},"上传并写入",8,$t)]),e[17]||(e[17]=a("p",{class:"hint sm"},"上传到 Firebase Storage，写入下载 URL 到 Firestore 对应键。",-1)),A.value?(h(),y("div",Mt,[e[15]||(e[15]=a("div",{class:"img-title"},"最新上传 URL：",-1)),a("a",{href:A.value,target:"_blank",rel:"noopener"},S(A.value),9,Ft),a("img",{src:A.value,alt:""},null,8,Ht)])):U("",!0)])):U("",!0),o.value?(h(),y("section",It,[e[21]||(e[21]=a("h3",null,"公告（News & Offers）",-1)),e[22]||(e[22]=a("p",{class:"hint sm"},"编辑后点「保存」；新增项先填写再点「新增」。",-1)),a("div",Rt,[e[20]||(e[20]=I('<div class="news-row head" data-v-5e94a80e><div class="c short" data-v-5e94a80e>置顶</div><div class="c short" data-v-5e94a80e>样式</div><div class="c grow" data-v-5e94a80e>标题</div><div class="c grow" data-v-5e94a80e>正文</div><div class="c grow" data-v-5e94a80e>按钮文案</div><div class="c grow" data-v-5e94a80e>按钮链接</div><div class="c mid" data-v-5e94a80e>开始</div><div class="c mid" data-v-5e94a80e>结束</div><div class="c short" data-v-5e94a80e>优先</div><div class="c ops" data-v-5e94a80e>操作</div></div>',1)),(h(!0),y(H,null,pt(O.value,t=>(h(),y("div",{class:"news-row",key:t._id},[a("div",Bt,[u(a("input",{type:"checkbox","onUpdate:modelValue":l=>t.pin=l},null,8,jt),[[R,t.pin]])]),a("div",Jt,[u(a("select",{"onUpdate:modelValue":l=>t.variant=l},[...e[18]||(e[18]=[a("option",{value:"info"},"info",-1),a("option",{value:"success"},"success",-1),a("option",{value:"warning"},"warning",-1),a("option",{value:"danger"},"danger",-1)])],8,Wt),[[B,t.variant]])]),a("div",Pt,[u(a("input",{"onUpdate:modelValue":l=>t.title=l},null,8,Kt),[[v,t.title]])]),a("div",Gt,[u(a("input",{"onUpdate:modelValue":l=>t.body=l},null,8,qt),[[v,t.body]])]),a("div",Qt,[u(a("input",{"onUpdate:modelValue":l=>t.ctaText=l},null,8,Xt),[[v,t.ctaText]])]),a("div",Zt,[u(a("input",{"onUpdate:modelValue":l=>t.ctaLink=l,placeholder:"/xxx 或 https://..."},null,8,zt),[[v,t.ctaLink]])]),a("div",te,[u(a("input",{"onUpdate:modelValue":l=>t.startAt=l,placeholder:"YYYY-MM-DD"},null,8,ee),[[v,t.startAt]])]),a("div",ae,[u(a("input",{"onUpdate:modelValue":l=>t.endAt=l,placeholder:"YYYY-MM-DD"},null,8,oe),[[v,t.endAt]])]),a("div",ne,[u(a("input",{type:"number","onUpdate:modelValue":l=>t.priority=l},null,8,se),[[v,t.priority,void 0,{number:!0}]])]),a("div",ie,[a("button",{class:"btn small",onClick:l=>nt(t)},"保存",8,le),a("button",{class:"btn small",onClick:l=>st(t)},"删除",8,de)])]))),128)),a("div",ce,[a("div",re,[u(a("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=t=>r.value.pin=t)},null,512),[[R,r.value.pin]])]),a("div",ue,[u(a("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>r.value.variant=t)},[...e[19]||(e[19]=[a("option",{value:"info"},"info",-1),a("option",{value:"success"},"success",-1),a("option",{value:"warning"},"warning",-1),a("option",{value:"danger"},"danger",-1)])],512),[[B,r.value.variant]])]),a("div",ve,[u(a("input",{"onUpdate:modelValue":e[3]||(e[3]=t=>r.value.title=t),placeholder:"标题"},null,512),[[v,r.value.title]])]),a("div",pe,[u(a("input",{"onUpdate:modelValue":e[4]||(e[4]=t=>r.value.body=t),placeholder:"正文..."},null,512),[[v,r.value.body]])]),a("div",me,[u(a("input",{"onUpdate:modelValue":e[5]||(e[5]=t=>r.value.ctaText=t),placeholder:"按钮文案"},null,512),[[v,r.value.ctaText]])]),a("div",fe,[u(a("input",{"onUpdate:modelValue":e[6]||(e[6]=t=>r.value.ctaLink=t),placeholder:"/path 或 https://..."},null,512),[[v,r.value.ctaLink]])]),a("div",ye,[u(a("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>r.value.startAt=t),placeholder:"YYYY-MM-DD"},null,512),[[v,r.value.startAt]])]),a("div",he,[u(a("input",{"onUpdate:modelValue":e[8]||(e[8]=t=>r.value.endAt=t),placeholder:"YYYY-MM-DD"},null,512),[[v,r.value.endAt]])]),a("div",ge,[u(a("input",{type:"number","onUpdate:modelValue":e[9]||(e[9]=t=>r.value.priority=t),placeholder:"0"},null,512),[[v,r.value.priority,void 0,{number:!0}]])]),a("div",{class:"c ops"},[a("button",{class:"btn small primary",onClick:ot},"新增")])])])])):U("",!0)]))}},ke=dt(be,[["__scopeId","data-v-5e94a80e"]]);export{ke as default};
